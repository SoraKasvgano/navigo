<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå°ç®¡ç† - ç½‘å€å¯¼èˆª</title>
    <style>
        :root {
            --apple-blue: #007AFF;
            --apple-secondary-bg: #2c2c2e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .navbar {
            background: var(--apple-blue);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar h1 {
            font-size: 20px;
            font-weight: 600;
        }

        .navbar-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .navbar-actions a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .navbar-actions a:hover {
            background: rgba(255,255,255,0.2);
        }

        .btn-logout {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }

        /* ä¸»ä½“å¸ƒå±€ */
        .container {
            display: flex;
            min-height: calc(100vh - 60px);
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 220px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            padding: 20px 0;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            border-left: 3px solid transparent;
        }

        .sidebar-menu li.active {
            border-left-color: var(--apple-blue);
            background: #f5f7fa;
        }

        .sidebar-menu a {
            display: block;
            padding: 12px 20px;
            color: #333;
            text-decoration: none;
            transition: all 0.3s;
        }

        .sidebar-menu a:hover {
            background: #f5f7fa;
            color: var(--apple-blue);
        }

        .sidebar-menu li.active a {
            color: var(--apple-blue);
            font-weight: 500;
        }

        /* å†…å®¹åŒº */
        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .panel {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .panel-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header h2 {
            font-size: 16px;
            color: #333;
        }

        .panel-body {
            padding: 20px;
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #666;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--apple-blue);
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        /* æŒ‰é’® */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--apple-blue);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* è¡¨æ ¼ */
        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 500;
            color: #666;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .action-btns {
            display: flex;
            gap: 5px;
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 16px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* åˆ—è¡¨é¡¹ */
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border: 1px solid #eee;
            border-radius: 6px;
            margin-bottom: 10px;
            background: #fafafa;
        }

        .list-item:hover {
            border-color: var(--apple-blue);
        }

        .list-item-info {
            flex: 1;
        }

        .list-item-title {
            font-weight: 500;
            color: #333;
        }

        .list-item-desc {
            font-size: 12px;
            color: #999;
            margin-top: 3px;
        }

        /* åˆ†ç±»å¡ç‰‡ */
        .category-card {
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .category-header {
            background: #f8f9fa;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .category-header:hover {
            background: #eef2ff;
        }

        .category-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .category-icon {
            font-size: 18px;
            color: var(--apple-blue);
        }

        .category-sites {
            padding: 15px;
            display: none;
        }

        .category-sites.active {
            display: block;
        }

        /* ç«™ç‚¹ç½‘æ ¼ */
        .sites-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
        }

        .site-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 6px;
            background: white;
        }

        .site-card img {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            object-fit: cover;
        }

        .site-info {
            flex: 1;
            min-width: 0;
        }

        .site-name {
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .site-desc {
            font-size: 12px;
            color: #999;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* æç¤ºæ¶ˆæ¯ */
        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 15px 25px;
            background: #28a745;
            color: white;
            border-radius: 6px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 2000;
            transform: translateX(150%);
            transition: transform 0.3s;
        }

        .toast.error {
            background: #dc3545;
        }

        .toast.show {
            transform: translateX(0);
        }

        /* æ–‡ä»¶ä¸Šä¼  */
        .file-upload {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .file-upload:hover {
            border-color: var(--apple-blue);
        }

        .file-upload input {
            display: none;
        }

        .file-upload-icon {
            font-size: 40px;
            color: #ddd;
            margin-bottom: 10px;
        }

        /* éšè—çš„é¢æ¿ */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Logoé¢„è§ˆ */
        .logo-preview {
            width: 100px;
            height: 100px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
        }

        .logo-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-top-color: var(--apple-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 50px;
            margin-bottom: 15px;
        }

        /* æ‹–æ‹½æ’åºæ ·å¼ */
        .sortable-list {
            min-height: 50px;
        }

        .drag-handle {
            cursor: grab;
            padding: 8px;
            color: #999;
            user-select: none;
            display: flex;
            align-items: center;
            font-size: 16px;
        }

        .drag-handle:hover {
            color: var(--apple-blue);
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .list-item.dragging {
            opacity: 0.5;
            background: #e3e8ff;
            border: 2px dashed var(--apple-blue);
        }

        .list-item.drag-over {
            border-top: 3px solid var(--apple-blue);
            margin-top: -3px;
        }

        .sort-hint {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
            padding: 8px 12px;
            background: #f0f4ff;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .sort-hint::before {
            content: "ğŸ’¡";
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="navbar">
        <h1>ç½‘å€å¯¼èˆª - åå°ç®¡ç†</h1>
        <div class="navbar-actions">
            <a href="/" target="_blank">è®¿é—®å‰å°</a>
            <button class="btn-logout" onclick="logout()">é€€å‡ºç™»å½•</button>
        </div>
    </nav>

    <div class="container">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar">
            <ul class="sidebar-menu">
                <li class="active" data-section="page-config"><a href="#page-config">é¡µé¢é…ç½®</a></li>
                <li data-section="announcements"><a href="#announcements">å…¬å‘Šç®¡ç†</a></li>
                <li data-section="categories"><a href="#categories">åˆ†ç±»ç®¡ç†</a></li>
                <li data-section="sites"><a href="#sites">ç«™ç‚¹ç®¡ç†</a></li>
                <li data-section="files"><a href="#files">æ–‡ä»¶ç®¡ç†</a></li>
                <li data-section="data"><a href="#data">æ•°æ®å¯¼å…¥å¯¼å‡º</a></li>
                <li data-section="password"><a href="#password">ä¿®æ”¹å¯†ç </a></li>
            </ul>
        </aside>

        <!-- å†…å®¹åŒº -->
        <main class="content">
            <!-- é¡µé¢é…ç½® -->
            <section id="page-config" class="section active">
                <div class="panel">
                    <div class="panel-header">
                        <h2>é¡µé¢é…ç½®</h2>
                    </div>
                    <div class="panel-body">
                        <form id="pageConfigForm">
                            <div class="form-group">
                                <label>é¡µé¢æ ‡é¢˜</label>
                                <input type="text" id="pageTitle" placeholder="ç½‘å€å¯¼èˆª">
                            </div>
                            <div class="form-group">
                                <label>å‰¯æ ‡é¢˜</label>
                                <input type="text" id="pageSubtitle" placeholder="å¸¸ç”¨ç½‘å€ä¸€é”®ç›´è¾¾">
                            </div>
                            <div class="form-group">
                                <label>Logo (URLæˆ–ä¸Šä¼ )</label>
                                <input type="text" id="pageLogo" placeholder="è¾“å…¥Logo URLæˆ–ä¸Šä¼ æ–‡ä»¶">
                                <div class="logo-preview" id="logoPreview">
                                    <img src="" alt="Logoé¢„è§ˆ">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>é¡µè„šæ–‡å­—</label>
                                <input type="text" id="pageFooter" placeholder="CopyRight...">
                            </div>
                            <div class="form-group">
                                <label>ICPå¤‡æ¡ˆå·</label>
                                <input type="text" id="pageIcp" placeholder="é²ICPå¤‡xxxxxå·">
                            </div>
                            <button type="submit" class="btn btn-primary">ä¿å­˜é…ç½®</button>
                        </form>
                    </div>
                </div>
            </section>

            <!-- å…¬å‘Šç®¡ç† -->
            <section id="announcements" class="section">
                <div class="panel">
                    <div class="panel-header">
                        <h2>å…¬å‘Šé…ç½®</h2>
                    </div>
                    <div class="panel-body">
                        <div class="form-group">
                            <label>è½®æ’­é—´éš” (æ¯«ç§’)</label>
                            <input type="number" id="announcementInterval" value="5000" min="1000">
                        </div>
                        <button class="btn btn-primary" onclick="saveAnnouncementConfig()">ä¿å­˜é…ç½®</button>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <h2>å…¬å‘Šåˆ—è¡¨</h2>
                        <button class="btn btn-primary btn-sm" onclick="showAddAnnouncementModal()">+ æ·»åŠ å…¬å‘Š</button>
                    </div>
                    <div class="panel-body">
                        <div id="announcementsList" class="loading">åŠ è½½ä¸­</div>
                    </div>
                </div>
            </section>

            <!-- åˆ†ç±»ç®¡ç† -->
            <section id="categories" class="section">
                <div class="panel">
                    <div class="panel-header">
                        <h2>åˆ†ç±»åˆ—è¡¨</h2>
                        <button class="btn btn-primary btn-sm" onclick="showAddCategoryModal()">+ æ·»åŠ åˆ†ç±»</button>
                    </div>
                    <div class="panel-body">
                        <div id="categoriesList" class="loading">åŠ è½½ä¸­</div>
                    </div>
                </div>
            </section>

            <!-- ç«™ç‚¹ç®¡ç† -->
            <section id="sites" class="section">
                <div class="panel">
                    <div class="panel-header">
                        <h2>ç«™ç‚¹ç®¡ç†</h2>
                        <button class="btn btn-primary btn-sm" onclick="showAddSiteModal()">+ æ·»åŠ ç«™ç‚¹</button>
                    </div>
                    <div class="panel-body">
                        <div id="sitesContainer" class="loading">åŠ è½½ä¸­</div>
                    </div>
                </div>
            </section>

            <!-- æ–‡ä»¶ç®¡ç† -->
            <section id="files" class="section">
                <div class="panel">
                    <div class="panel-header">
                        <h2>ä¸Šä¼ æ–‡ä»¶</h2>
                    </div>
                    <div class="panel-body">
                        <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                            <div class="file-upload-icon">ğŸ“</div>
                            <p>ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œä¸Šä¼ </p>
                            <p style="font-size: 12px; color: #999;">æ”¯æŒå›¾ç‰‡ã€å‹ç¼©åŒ…ç­‰æ–‡ä»¶</p>
                            <input type="file" id="fileInput" onchange="uploadFile(this)">
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <h2>å·²ä¸Šä¼ æ–‡ä»¶</h2>
                    </div>
                    <div class="panel-body">
                        <div id="filesList" class="loading">åŠ è½½ä¸­</div>
                    </div>
                </div>
            </section>

            <!-- æ•°æ®å¯¼å…¥å¯¼å‡º -->
            <section id="data" class="section">
                <div class="panel">
                    <div class="panel-header">
                        <h2>å®Œæ•´å¤‡ä»½ï¼ˆæ¨èï¼‰</h2>
                    </div>
                    <div class="panel-body">
                        <p style="font-size: 13px; color: #666; margin-bottom: 15px; padding: 10px; background: #f0f4ff; border-radius: 6px;">
                            å®Œæ•´å¤‡ä»½åŒ…å«æ‰€æœ‰å¯¼èˆªæ•°æ®å’Œä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶ï¼Œæ‰“åŒ…ä¸ºZIPæ ¼å¼ï¼Œé€‚åˆå®Œæ•´è¿ç§»æˆ–å®šæœŸå¤‡ä»½ã€‚
                        </p>
                        <div class="form-row">
                            <div class="form-group">
                                <label>å¯¼å‡ºå®Œæ•´å¤‡ä»½</label>
                                <p style="font-size: 12px; color: #999; margin-bottom: 10px;">å¯¼å‡ºæ•°æ®å’Œå›¾ç‰‡ä¸ºZIPå‹ç¼©åŒ…</p>
                                <button class="btn btn-primary" onclick="exportBackup()">å¯¼å‡ºå¤‡ä»½ (ZIP)</button>
                            </div>
                            <div class="form-group">
                                <label>å¯¼å…¥å®Œæ•´å¤‡ä»½</label>
                                <p style="font-size: 12px; color: #999; margin-bottom: 10px;">å¯¼å…¥ZIPæ ¼å¼çš„å®Œæ•´å¤‡ä»½æ–‡ä»¶</p>
                                <input type="file" id="importBackupFile" accept=".zip" style="display:none" onchange="importBackup(this)">
                                <button class="btn btn-secondary" onclick="document.getElementById('importBackupFile').click()">é€‰æ‹©ZIPæ–‡ä»¶å¯¼å…¥</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <h2>æ•°æ®å¯¼å…¥å¯¼å‡ºï¼ˆä»…JSONï¼‰</h2>
                    </div>
                    <div class="panel-body">
                        <p style="font-size: 13px; color: #666; margin-bottom: 15px; padding: 10px; background: #fff8e6; border-radius: 6px;">
                            ä»…å¯¼å‡ºå¯¼èˆªæ•°æ®ï¼Œä¸åŒ…å«ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶ã€‚é€‚åˆå¿«é€Ÿå¯¼å‡ºæ•°æ®ç»“æ„ã€‚
                        </p>
                        <div class="form-row">
                            <div class="form-group">
                                <label>å¯¼å‡ºæ•°æ®</label>
                                <p style="font-size: 12px; color: #999; margin-bottom: 10px;">å¯¼å‡ºæ‰€æœ‰å¯¼èˆªæ•°æ®ä¸ºJSONæ–‡ä»¶</p>
                                <button class="btn btn-primary" onclick="exportData()">å¯¼å‡ºæ•°æ® (JSON)</button>
                            </div>
                            <div class="form-group">
                                <label>å¯¼å…¥æ•°æ®</label>
                                <p style="font-size: 12px; color: #999; margin-bottom: 10px;">å¯¼å…¥nav.jsonæ ¼å¼çš„æ•°æ®æ–‡ä»¶</p>
                                <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(this)">
                                <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">é€‰æ‹©JSONæ–‡ä»¶å¯¼å…¥</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ä¿®æ”¹å¯†ç  -->
            <section id="password" class="section">
                <div class="panel">
                    <div class="panel-header">
                        <h2>ä¿®æ”¹å¯†ç </h2>
                    </div>
                    <div class="panel-body">
                        <form id="passwordForm" onsubmit="changePassword(event)">
                            <div class="form-group">
                                <label>å½“å‰å¯†ç </label>
                                <input type="password" id="oldPassword" placeholder="è¯·è¾“å…¥å½“å‰å¯†ç " required>
                            </div>
                            <div class="form-group">
                                <label>æ–°å¯†ç </label>
                                <input type="password" id="newPassword" placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" required minlength="6">
                            </div>
                            <div class="form-group">
                                <label>ç¡®è®¤æ–°å¯†ç </label>
                                <input type="password" id="confirmPassword" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " required minlength="6">
                            </div>
                            <button type="submit" class="btn btn-primary">ä¿®æ”¹å¯†ç </button>
                        </form>
                        <p style="font-size: 12px; color: #999; margin-top: 15px;">
                            æ³¨æ„ï¼šä¿®æ”¹å¯†ç åéœ€è¦é‡æ–°ç™»å½•
                        </p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- å…¬å‘Šç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal" id="announcementModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="announcementModalTitle">æ·»åŠ å…¬å‘Š</h3>
                <button class="modal-close" onclick="closeModal('announcementModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="announcementForm">
                    <input type="hidden" id="announcementId">
                    <div class="form-group">
                        <label>æ—¶é—´æ ‡è®°</label>
                        <input type="text" id="announcementTimestamp" placeholder="å¦‚: 2024/01/01">
                    </div>
                    <div class="form-group">
                        <label>å…¬å‘Šå†…å®¹</label>
                        <textarea id="announcementContent" rows="4" placeholder="å…¬å‘Šå†…å®¹..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('announcementModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveAnnouncement()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- åˆ†ç±»ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="categoryModalTitle">æ·»åŠ åˆ†ç±»</h3>
                <button class="modal-close" onclick="closeModal('categoryModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    <input type="hidden" id="categoryId">
                    <div class="form-group">
                        <label>åˆ†ç±»ID (è‹±æ–‡)</label>
                        <input type="text" id="categoryIdStr" placeholder="å¦‚: company_resource">
                    </div>
                    <div class="form-group">
                        <label>åˆ†ç±»åç§°</label>
                        <input type="text" id="categoryClassify" placeholder="å¦‚: å…¬å¸èµ„æº">
                    </div>
                    <div class="form-group">
                        <label>å›¾æ ‡ (Themify Icons)</label>
                        <input type="text" id="categoryIcon" placeholder="å¦‚: ti-cloud">
                        <p style="font-size: 12px; color: #999; margin-top: 5px;">
                            <a href="https://themify.me/themify-icons" target="_blank">æŸ¥çœ‹å›¾æ ‡åˆ—è¡¨</a>
                        </p>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('categoryModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveCategory()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- ç«™ç‚¹ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal" id="siteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="siteModalTitle">æ·»åŠ ç«™ç‚¹</h3>
                <button class="modal-close" onclick="closeModal('siteModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="siteForm">
                    <input type="hidden" id="siteId">
                    <div class="form-group">
                        <label>æ‰€å±åˆ†ç±»</label>
                        <select id="siteCatId"></select>
                    </div>
                    <div class="form-group">
                        <label>ç«™ç‚¹ç±»å‹</label>
                        <select id="siteType" onchange="toggleSiteTypeFields()">
                            <option value="link">è¶…é“¾æ¥</option>
                            <option value="download">ä¸‹è½½é“¾æ¥</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ç«™ç‚¹åç§°</label>
                        <input type="text" id="siteName" placeholder="ç«™ç‚¹åç§°">
                    </div>
                    <div class="form-group" id="siteLinkGroup">
                        <label>é“¾æ¥åœ°å€</label>
                        <input type="text" id="siteHref" placeholder="https://example.com">
                    </div>
                    <div class="form-group" id="siteFileGroup" style="display:none">
                        <label>ä¸Šä¼ æ–‡ä»¶</label>
                        <p style="font-size:12px;color:#999;margin-bottom:5px">æ”¯æŒæ ¼å¼: txt, pdf, ppt, pptx, xls, xlsx, doc, docx, rar, zip, 7z</p>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="uploadSiteFile()">é€‰æ‹©æ–‡ä»¶ä¸Šä¼ </button>
                        <input type="file" id="siteFileInput" style="display:none" accept=".txt,.pdf,.ppt,.pptx,.xls,.xlsx,.doc,.docx,.rar,.zip,.7z" onchange="handleSiteFileUpload(this)">
                        <div id="siteFileInfo" style="margin-top:5px;font-size:12px;color:#666"></div>
                    </div>
                    <div class="form-group">
                        <label>æè¿°</label>
                        <input type="text" id="siteDesc" placeholder="ç«™ç‚¹æè¿°">
                    </div>
                    <div class="form-group">
                        <label>ç«™ç‚¹å›¾æ ‡</label>
                        <p style="font-size:12px;color:#999;margin-bottom:5px">æ”¯æŒæ ¼å¼: png, jpg, jpeg, gif, webp, ico</p>
                        <div style="display:flex;gap:10px;align-items:flex-start">
                            <input type="text" id="siteLogo" placeholder="å›¾æ ‡URL" style="flex:1" oninput="previewSiteLogo()">
                            <button type="button" class="btn btn-secondary btn-sm" onclick="uploadSiteLogo()">ä¸Šä¼ å›¾æ ‡</button>
                        </div>
                        <input type="file" id="siteLogoInput" style="display:none" accept=".png,.jpg,.jpeg,.gif,.webp,.ico" onchange="handleSiteLogoUpload(this)">
                        <div class="logo-preview" id="siteLogoPreview" style="margin-top:10px">
                            <img src="" alt="å›¾æ ‡é¢„è§ˆ" style="display:none">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('siteModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveSite()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- æç¤ºæ¶ˆæ¯ -->
    <div class="toast" id="toast"></div>

    <script>
        // å…¨å±€æ•°æ®
        let categories = [];
        let announcements = [];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            initSidebar();
            loadPageConfig();
            loadAnnouncements();
            loadCategories();
            loadFiles();
        });

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkAuth() {
            try {
                const res = await fetch('/api/check-auth');
                const data = await res.json();
                if (!data.authenticated) {
                    window.location.href = '/login';
                }
            } catch (error) {
                window.location.href = '/login';
            }
        }

        // é€€å‡ºç™»å½•
        async function logout() {
            try {
                await fetch('/api/admin/logout', { method: 'POST' });
            } catch (error) {}
            window.location.href = '/login';
        }

        // ä¾§è¾¹æ åˆ‡æ¢
        function initSidebar() {
            document.querySelectorAll('.sidebar-menu li').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.dataset.section;

                    document.querySelectorAll('.sidebar-menu li').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');

                    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                    document.getElementById(section).classList.add('active');
                });
            });
        }

        // æ˜¾ç¤ºæç¤º
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast' + (isError ? ' error' : '');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // æ¨¡æ€æ¡†æ“ä½œ
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function showModal(id) {
            document.getElementById(id).classList.add('active');
        }

        // ==================== é¡µé¢é…ç½® ====================
        async function loadPageConfig() {
            try {
                const res = await fetch('/api/admin/page-config');
                const data = await res.json();
                if (data.code === 0) {
                    document.getElementById('pageTitle').value = data.data.title || '';
                    document.getElementById('pageSubtitle').value = data.data.subtitle || '';
                    document.getElementById('pageLogo').value = data.data.logo || '';
                    document.getElementById('pageFooter').value = data.data.footer_text || '';
                    document.getElementById('pageIcp').value = data.data.icp || '';
                    updateLogoPreview();
                }
            } catch (error) {
                showToast('åŠ è½½é¡µé¢é…ç½®å¤±è´¥', true);
            }
        }

        function updateLogoPreview() {
            const logo = document.getElementById('pageLogo').value;
            const preview = document.getElementById('logoPreview').querySelector('img');
            if (logo) {
                preview.src = logo;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        }

        document.getElementById('pageLogo').addEventListener('input', updateLogoPreview);

        document.getElementById('pageConfigForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            try {
                const res = await fetch('/api/admin/page-config', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: document.getElementById('pageTitle').value,
                        subtitle: document.getElementById('pageSubtitle').value,
                        logo: document.getElementById('pageLogo').value,
                        footer_text: document.getElementById('pageFooter').value,
                        icp: document.getElementById('pageIcp').value
                    })
                });
                const data = await res.json();
                if (data.code === 0) {
                    showToast('ä¿å­˜æˆåŠŸ');
                } else {
                    showToast(data.message || 'ä¿å­˜å¤±è´¥', true);
                }
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥', true);
            }
        });

        // ==================== å…¬å‘Šç®¡ç† ====================
        async function loadAnnouncements() {
            const container = document.getElementById('announcementsList');
            container.className = 'loading';
            container.innerHTML = 'åŠ è½½ä¸­';

            try {
                // åŠ è½½é…ç½®
                const configRes = await fetch('/api/admin/announcement-config');
                const configData = await configRes.json();
                if (configData.code === 0) {
                    document.getElementById('announcementInterval').value = configData.data.interval || 5000;
                }

                // åŠ è½½å…¬å‘Šåˆ—è¡¨
                const res = await fetch('/api/admin/announcements');
                const data = await res.json();

                container.className = ''; // ç§»é™¤loadingç±»

                if (data.code === 0 && data.data && data.data.length > 0) {
                    announcements = data.data;
                    container.innerHTML = announcements.map(ann => `
                        <div class="list-item">
                            <div class="list-item-info">
                                <div class="list-item-title">${escapeHtml(ann.content)}</div>
                                <div class="list-item-desc">${escapeHtml(ann.timestamp)}</div>
                            </div>
                            <div class="action-btns">
                                <button class="btn btn-primary btn-sm" onclick="editAnnouncement(${ann.id})">ç¼–è¾‘</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteAnnouncement(${ann.id})">åˆ é™¤</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“¢</div><p>æš‚æ— å…¬å‘Š</p></div>';
                }
            } catch (error) {
                container.className = '';
                container.innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
            }
        }

        async function saveAnnouncementConfig() {
            try {
                const res = await fetch('/api/admin/announcement-config', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        interval: parseInt(document.getElementById('announcementInterval').value)
                    })
                });
                const data = await res.json();
                if (data.code === 0) {
                    showToast('ä¿å­˜æˆåŠŸ');
                } else {
                    showToast(data.message || 'ä¿å­˜å¤±è´¥', true);
                }
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥', true);
            }
        }

        function showAddAnnouncementModal() {
            document.getElementById('announcementModalTitle').textContent = 'æ·»åŠ å…¬å‘Š';
            document.getElementById('announcementId').value = '';
            // è‡ªåŠ¨å¡«å……å½“å‰æ—¶é—´ï¼Œæ ¼å¼ï¼šYYYY-MM-DD HH:mm
            const now = new Date();
            const timestamp = now.getFullYear() + '-' +
                String(now.getMonth() + 1).padStart(2, '0') + '-' +
                String(now.getDate()).padStart(2, '0') + ' ' +
                String(now.getHours()).padStart(2, '0') + ':' +
                String(now.getMinutes()).padStart(2, '0');
            document.getElementById('announcementTimestamp').value = timestamp;
            document.getElementById('announcementContent').value = '';
            showModal('announcementModal');
        }

        function editAnnouncement(id) {
            const ann = announcements.find(a => a.id === id);
            if (ann) {
                document.getElementById('announcementModalTitle').textContent = 'ç¼–è¾‘å…¬å‘Š';
                document.getElementById('announcementId').value = ann.id;
                document.getElementById('announcementTimestamp').value = ann.timestamp;
                document.getElementById('announcementContent').value = ann.content;
                showModal('announcementModal');
            }
        }

        async function saveAnnouncement() {
            const id = document.getElementById('announcementId').value;
            const data = {
                timestamp: document.getElementById('announcementTimestamp').value,
                content: document.getElementById('announcementContent').value
            };

            try {
                const url = id ? `/api/admin/announcements/${id}` : '/api/admin/announcements';
                const method = id ? 'PUT' : 'POST';
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.code === 0) {
                    showToast('ä¿å­˜æˆåŠŸ');
                    closeModal('announcementModal');
                    loadAnnouncements();
                } else {
                    showToast(result.message || 'ä¿å­˜å¤±è´¥', true);
                }
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥', true);
            }
        }

        async function deleteAnnouncement(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å…¬å‘Šå—ï¼Ÿ')) return;
            try {
                const res = await fetch(`/api/admin/announcements/${id}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.code === 0) {
                    showToast('åˆ é™¤æˆåŠŸ');
                    loadAnnouncements();
                } else {
                    showToast(data.message || 'åˆ é™¤å¤±è´¥', true);
                }
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥', true);
            }
        }

        // ==================== åˆ†ç±»ç®¡ç† ====================
        async function loadCategories() {
            const container = document.getElementById('categoriesList');
            container.className = 'loading';
            container.innerHTML = 'åŠ è½½ä¸­';

            try {
                const res = await fetch('/api/admin/categories');
                const data = await res.json();

                container.className = ''; // ç§»é™¤loadingç±»

                if (data.code === 0 && data.data && data.data.length > 0) {
                    categories = data.data;
                    container.innerHTML = `
                        <div class="sort-hint">æ‹–æ‹½å·¦ä¾§å›¾æ ‡å¯è°ƒæ•´åˆ†ç±»é¡ºåº</div>
                        <div class="sortable-list" id="categorySortable">
                            ${categories.map(cat => `
                                <div class="list-item" draggable="true" data-id="${cat.id}">
                                    <div class="drag-handle" title="æ‹–æ‹½æ’åº">â˜°</div>
                                    <div class="list-item-info">
                                        <div class="list-item-title"><i class="${cat.icon}"></i> ${escapeHtml(cat.classify)}</div>
                                        <div class="list-item-desc">ID: ${escapeHtml(cat._id)}</div>
                                    </div>
                                    <div class="action-btns">
                                        <button class="btn btn-primary btn-sm" onclick="editCategory(${cat.id})">ç¼–è¾‘</button>
                                        <button class="btn btn-danger btn-sm" onclick="deleteCategory(${cat.id})">åˆ é™¤</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;

                    // åˆå§‹åŒ–åˆ†ç±»æ‹–æ‹½æ’åº
                    initDragSort(document.getElementById('categorySortable'), saveCategorySort);

                    // æ›´æ–°ç«™ç‚¹é¡µé¢çš„åˆ†ç±»é€‰æ‹©
                    updateCategorySelect();
                    loadSites();
                } else {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“</div><p>æš‚æ— åˆ†ç±»</p></div>';
                }
            } catch (error) {
                container.className = '';
                container.innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
            }
        }

        function updateCategorySelect() {
            const select = document.getElementById('siteCatId');
            select.innerHTML = categories.map(cat =>
                `<option value="${cat.id}">${escapeHtml(cat.classify)}</option>`
            ).join('');
        }

        function showAddCategoryModal() {
            document.getElementById('categoryModalTitle').textContent = 'æ·»åŠ åˆ†ç±»';
            document.getElementById('categoryId').value = '';
            document.getElementById('categoryIdStr').value = '';
            document.getElementById('categoryClassify').value = '';
            document.getElementById('categoryIcon').value = 'ti-folder';
            showModal('categoryModal');
        }

        function editCategory(id) {
            const cat = categories.find(c => c.id === id);
            if (cat) {
                document.getElementById('categoryModalTitle').textContent = 'ç¼–è¾‘åˆ†ç±»';
                document.getElementById('categoryId').value = cat.id;
                document.getElementById('categoryIdStr').value = cat._id;
                document.getElementById('categoryClassify').value = cat.classify;
                document.getElementById('categoryIcon').value = cat.icon;
                showModal('categoryModal');
            }
        }

        async function saveCategory() {
            const id = document.getElementById('categoryId').value;
            const data = {
                _id: document.getElementById('categoryIdStr').value,
                classify: document.getElementById('categoryClassify').value,
                icon: document.getElementById('categoryIcon').value
            };

            try {
                const url = id ? `/api/admin/categories/${id}` : '/api/admin/categories';
                const method = id ? 'PUT' : 'POST';
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.code === 0) {
                    showToast('ä¿å­˜æˆåŠŸ');
                    closeModal('categoryModal');
                    loadCategories();
                } else {
                    showToast(result.message || 'ä¿å­˜å¤±è´¥', true);
                }
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥', true);
            }
        }

        async function deleteCategory(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåˆ†ç±»å—ï¼Ÿè¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰ç«™ç‚¹ä¹Ÿä¼šè¢«åˆ é™¤ï¼')) return;
            try {
                const res = await fetch(`/api/admin/categories/${id}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.code === 0) {
                    showToast('åˆ é™¤æˆåŠŸ');
                    loadCategories();
                } else {
                    showToast(data.message || 'åˆ é™¤å¤±è´¥', true);
                }
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥', true);
            }
        }

        // ==================== ç«™ç‚¹ç®¡ç† ====================
        async function loadSites() {
            const container = document.getElementById('sitesContainer');

            if (categories.length === 0) {
                container.className = '';
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸŒ</div><p>è¯·å…ˆåˆ›å»ºåˆ†ç±»</p></div>';
                return;
            }

            container.className = 'loading';
            container.innerHTML = 'åŠ è½½ä¸­';

            try {
                let html = '';
                for (const cat of categories) {
                    const res = await fetch(`/api/admin/categories/${cat.id}/sites`);
                    const data = await res.json();
                    const sites = data.code === 0 ? data.data || [] : [];

                    html += `
                        <div class="category-card">
                            <div class="category-header" onclick="toggleCategorySites(this)">
                                <div class="category-title">
                                    <i class="${cat.icon} category-icon"></i>
                                    <span>${escapeHtml(cat.classify)}</span>
                                    <span style="color:#999;font-size:12px">(${sites.length}ä¸ªç«™ç‚¹)</span>
                                </div>
                                <span>â–¼</span>
                            </div>
                            <div class="category-sites">
                                ${sites.length > 0 ? `
                                    <div class="sort-hint">æ‹–æ‹½å·¦ä¾§å›¾æ ‡å¯è°ƒæ•´ç«™ç‚¹é¡ºåº</div>
                                    <div class="sortable-list" id="siteSortable_${cat.id}" data-cat-id="${cat.id}">
                                        ${sites.map(site => `
                                            <div class="list-item" draggable="true" data-id="${site.id}">
                                                <div class="drag-handle" title="æ‹–æ‹½æ’åº">â˜°</div>
                                                <div class="list-item-info" style="display:flex;align-items:center;gap:10px">
                                                    ${site.logo ? `<img src="${site.logo}" style="width:24px;height:24px;border-radius:4px" onerror="this.style.display='none'">` : ''}
                                                    <div>
                                                        <div class="list-item-title">${escapeHtml(site.name)}</div>
                                                        <div class="list-item-desc">${escapeHtml(site.href)}</div>
                                                    </div>
                                                </div>
                                                <div class="action-btns">
                                                    <button class="btn btn-primary btn-sm" onclick="editSite(${site.id}, ${cat.id})">ç¼–è¾‘</button>
                                                    <button class="btn btn-danger btn-sm" onclick="deleteSite(${site.id})">åˆ é™¤</button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<div class="empty-state" style="padding:20px"><p>æš‚æ— ç«™ç‚¹</p></div>'}
                            </div>
                        </div>
                    `;
                }
                container.className = ''; // ç§»é™¤loadingç±»
                container.innerHTML = html;

                // åˆå§‹åŒ–æ¯ä¸ªåˆ†ç±»ä¸‹çš„ç«™ç‚¹æ‹–æ‹½æ’åº
                for (const cat of categories) {
                    const sortableEl = document.getElementById(`siteSortable_${cat.id}`);
                    if (sortableEl) {
                        initDragSort(sortableEl, () => saveSiteSort(cat.id));
                    }
                }
            } catch (error) {
                container.className = '';
                container.innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
            }
        }

        function toggleCategorySites(header) {
            const sites = header.nextElementSibling;
            sites.classList.toggle('active');
        }

        // åˆ‡æ¢ç«™ç‚¹ç±»å‹æ˜¾ç¤º
        function toggleSiteTypeFields() {
            const siteType = document.getElementById('siteType').value;
            const linkGroup = document.getElementById('siteLinkGroup');
            const fileGroup = document.getElementById('siteFileGroup');

            if (siteType === 'link') {
                linkGroup.style.display = 'block';
                fileGroup.style.display = 'none';
            } else {
                linkGroup.style.display = 'none';
                fileGroup.style.display = 'block';
            }
        }

        // é¢„è§ˆç«™ç‚¹å›¾æ ‡
        function previewSiteLogo() {
            const logo = document.getElementById('siteLogo').value;
            const preview = document.getElementById('siteLogoPreview').querySelector('img');
            if (logo) {
                preview.src = logo;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        }

        // ä¸Šä¼ ç«™ç‚¹å›¾æ ‡
        function uploadSiteLogo() {
            document.getElementById('siteLogoInput').click();
        }

        // å¤„ç†ç«™ç‚¹å›¾æ ‡ä¸Šä¼ 
        async function handleSiteLogoUpload(input) {
            if (!input.files || !input.files[0]) return;

            const file = input.files[0];
            const allowedTypes = ['image/png', 'image/jpeg', 'image/gif', 'image/webp', 'image/x-icon', 'image/vnd.microsoft.icon'];
            const allowedExts = ['.png', '.jpg', '.jpeg', '.gif', '.webp', '.ico'];
            const ext = '.' + file.name.split('.').pop().toLowerCase();

            if (!allowedExts.includes(ext)) {
                showToast('ä¸æ”¯æŒçš„å›¾ç‰‡æ ¼å¼ï¼Œè¯·ä¸Šä¼  png, jpg, jpeg, gif, webp, ico æ ¼å¼', true);
                input.value = '';
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('type', 'logo');

            try {
                const res = await fetch('/api/admin/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (data.code === 0) {
                    document.getElementById('siteLogo').value = data.data.url;
                    previewSiteLogo();
                    showToast('å›¾æ ‡ä¸Šä¼ æˆåŠŸ');
                } else {
                    showToast(data.message || 'ä¸Šä¼ å¤±è´¥', true);
                }
            } catch (error) {
                showToast('ä¸Šä¼ å¤±è´¥', true);
            }
            input.value = '';
        }

        function showAddSiteModal() {
            document.getElementById('siteModalTitle').textContent = 'æ·»åŠ ç«™ç‚¹';
            document.getElementById('siteId').value = '';
            document.getElementById('siteCatId').value = categories[0]?.id || '';
            document.getElementById('siteType').value = 'link';
            document.getElementById('siteName').value = '';
            document.getElementById('siteHref').value = '';
            document.getElementById('siteDesc').value = '';
            document.getElementById('siteLogo').value = '';
            document.getElementById('siteFileInfo').textContent = '';
            document.getElementById('siteLogoPreview').querySelector('img').style.display = 'none';
            toggleSiteTypeFields();
            showModal('siteModal');
        }

        async function editSite(id, catId) {
            try {
                const res = await fetch(`/api/admin/sites/${id}`);
                const data = await res.json();
                if (data.code === 0) {
                    const site = data.data;
                    document.getElementById('siteModalTitle').textContent = 'ç¼–è¾‘ç«™ç‚¹';
                    document.getElementById('siteId').value = site.id;
                    document.getElementById('siteCatId').value = site.cat_id || catId;
                    document.getElementById('siteName').value = site.name;
                    document.getElementById('siteHref').value = site.href;
                    document.getElementById('siteDesc').value = site.desc || '';
                    document.getElementById('siteLogo').value = site.logo || '';

                    // åˆ¤æ–­ç«™ç‚¹ç±»å‹ï¼šå¦‚æœhrefæ˜¯ä¸Šä¼ çš„æ–‡ä»¶è·¯å¾„åˆ™ä¸ºä¸‹è½½ç±»å‹
                    const isDownload = site.href && site.href.startsWith('/uploads/');
                    document.getElementById('siteType').value = isDownload ? 'download' : 'link';
                    if (isDownload) {
                        document.getElementById('siteFileInfo').textContent = 'å½“å‰æ–‡ä»¶: ' + site.href.split('/').pop();
                    } else {
                        document.getElementById('siteFileInfo').textContent = '';
                    }

                    toggleSiteTypeFields();
                    previewSiteLogo();
                    showModal('siteModal');
                }
            } catch (error) {
                showToast('åŠ è½½ç«™ç‚¹ä¿¡æ¯å¤±è´¥', true);
            }
        }

        async function saveSite() {
            const id = document.getElementById('siteId').value;
            const data = {
                cat_id: parseInt(document.getElementById('siteCatId').value),
                name: document.getElementById('siteName').value,
                href: document.getElementById('siteHref').value,
                desc: document.getElementById('siteDesc').value,
                logo: document.getElementById('siteLogo').value
            };

            try {
                const url = id ? `/api/admin/sites/${id}` : '/api/admin/sites';
                const method = id ? 'PUT' : 'POST';
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.code === 0) {
                    showToast('ä¿å­˜æˆåŠŸ');
                    closeModal('siteModal');
                    loadSites();
                } else {
                    showToast(result.message || 'ä¿å­˜å¤±è´¥', true);
                }
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥', true);
            }
        }

        async function deleteSite(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç«™ç‚¹å—ï¼Ÿ')) return;
            try {
                const res = await fetch(`/api/admin/sites/${id}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.code === 0) {
                    showToast('åˆ é™¤æˆåŠŸ');
                    loadSites();
                } else {
                    showToast(data.message || 'åˆ é™¤å¤±è´¥', true);
                }
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥', true);
            }
        }

        function uploadSiteFile() {
            document.getElementById('siteFileInput').click();
        }

        async function handleSiteFileUpload(input) {
            if (!input.files || !input.files[0]) return;

            const file = input.files[0];
            const allowedExts = ['.txt', '.pdf', '.ppt', '.pptx', '.xls', '.xlsx', '.doc', '.docx', '.rar', '.zip', '.7z'];
            const ext = '.' + file.name.split('.').pop().toLowerCase();

            if (!allowedExts.includes(ext)) {
                showToast('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œè¯·ä¸Šä¼  txt, pdf, ppt, pptx, xls, xlsx, doc, docx, rar, zip, 7z æ ¼å¼', true);
                input.value = '';
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('type', 'document');

            try {
                const res = await fetch('/api/admin/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (data.code === 0) {
                    document.getElementById('siteHref').value = data.data.url;
                    document.getElementById('siteFileInfo').textContent = 'å·²ä¸Šä¼ : ' + file.name;
                    showToast('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ');
                } else {
                    showToast(data.message || 'ä¸Šä¼ å¤±è´¥', true);
                }
            } catch (error) {
                showToast('ä¸Šä¼ å¤±è´¥', true);
            }
            input.value = '';
        }

        // ==================== æ–‡ä»¶ç®¡ç† ====================
        async function loadFiles() {
            const container = document.getElementById('filesList');
            container.className = 'loading';
            container.innerHTML = 'åŠ è½½ä¸­';

            try {
                const res = await fetch('/api/admin/files');
                const data = await res.json();

                container.className = ''; // ç§»é™¤loadingç±»

                if (data.code === 0 && data.data && data.data.length > 0) {
                    container.innerHTML = `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>æ–‡ä»¶å</th>
                                    <th>å¤§å°</th>
                                    <th>ä¸Šä¼ æ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.data.map(file => `
                                    <tr>
                                        <td><a href="${file.url}" target="_blank">${escapeHtml(file.name)}</a></td>
                                        <td>${formatFileSize(file.size)}</td>
                                        <td>${file.uploaded_at || '-'}</td>
                                        <td>
                                            <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('${file.url}')">å¤åˆ¶é“¾æ¥</button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteFile('${file.name}')">åˆ é™¤</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“‚</div><p>æš‚æ— æ–‡ä»¶</p></div>';
                }
            } catch (error) {
                container.className = '';
                container.innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
            }
        }

        async function uploadFile(input) {
            if (!input.files || !input.files[0]) return;

            const formData = new FormData();
            formData.append('file', input.files[0]);

            try {
                const res = await fetch('/api/admin/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (data.code === 0) {
                    showToast('ä¸Šä¼ æˆåŠŸ');
                    loadFiles();
                } else {
                    showToast(data.message || 'ä¸Šä¼ å¤±è´¥', true);
                }
            } catch (error) {
                showToast('ä¸Šä¼ å¤±è´¥', true);
            }
            input.value = '';
        }

        async function deleteFile(filename) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) return;
            try {
                const res = await fetch('/api/admin/upload?filename=' + encodeURIComponent(filename), {
                    method: 'DELETE'
                });
                const data = await res.json();
                if (data.code === 0) {
                    showToast('åˆ é™¤æˆåŠŸ');
                    loadFiles();
                } else {
                    showToast(data.message || 'åˆ é™¤å¤±è´¥', true);
                }
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥', true);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(window.location.origin + text).then(() => {
                showToast('é“¾æ¥å·²å¤åˆ¶');
            }).catch(() => {
                showToast('å¤åˆ¶å¤±è´¥', true);
            });
        }

        // ==================== æ•°æ®å¯¼å…¥å¯¼å‡º ====================
        function exportData() {
            window.location.href = '/api/admin/export';
        }

        // å¯¼å‡ºå®Œæ•´å¤‡ä»½ï¼ˆZIPæ ¼å¼ï¼ŒåŒ…å«å›¾ç‰‡ï¼‰
        function exportBackup() {
            showToast('æ­£åœ¨å‡†å¤‡å¤‡ä»½æ–‡ä»¶...');
            window.location.href = '/api/admin/backup/export';
        }

        // å¯¼å…¥å®Œæ•´å¤‡ä»½ï¼ˆZIPæ ¼å¼ï¼‰
        async function importBackup(input) {
            if (!input.files || !input.files[0]) return;

            const file = input.files[0];
            if (!file.name.toLowerCase().endsWith('.zip')) {
                showToast('è¯·é€‰æ‹©ZIPæ ¼å¼çš„å¤‡ä»½æ–‡ä»¶', true);
                input.value = '';
                return;
            }

            if (!confirm('å¯¼å…¥å¤‡ä»½å°†è¦†ç›–ç°æœ‰çš„æ‰€æœ‰æ•°æ®å’Œå›¾ç‰‡ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) {
                input.value = '';
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                showToast('æ­£åœ¨å¯¼å…¥å¤‡ä»½ï¼Œè¯·ç¨å€™...');
                const res = await fetch('/api/admin/backup/import', {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();
                if (result.code === 0) {
                    showToast('å¤‡ä»½å¯¼å…¥æˆåŠŸ');
                    // é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®
                    loadCategories();
                    loadAnnouncements();
                    loadFiles();
                } else {
                    showToast(result.message || 'å¤‡ä»½å¯¼å…¥å¤±è´¥', true);
                }
            } catch (error) {
                showToast('å¤‡ä»½å¯¼å…¥å¤±è´¥: ' + error.message, true);
            }
            input.value = '';
        }

        async function importData(input) {
            if (!input.files || !input.files[0]) return;

            if (!confirm('å¯¼å…¥å°†è¦†ç›–ç°æœ‰æ•°æ®ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) {
                input.value = '';
                return;
            }

            try {
                const text = await input.files[0].text();
                const data = JSON.parse(text);

                const res = await fetch('/api/admin/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.code === 0) {
                    showToast('å¯¼å…¥æˆåŠŸ');
                    loadCategories();
                    loadAnnouncements();
                } else {
                    showToast(result.message || 'å¯¼å…¥å¤±è´¥', true);
                }
            } catch (error) {
                showToast('å¯¼å…¥å¤±è´¥: ' + error.message, true);
            }
            input.value = '';
        }

        // ==================== å·¥å…·å‡½æ•° ====================
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatFileSize(bytes) {
            if (!bytes) return '-';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1024 / 1024).toFixed(1) + ' MB';
        }

        // ==================== ä¿®æ”¹å¯†ç  ====================
        async function changePassword(event) {
            event.preventDefault();

            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // å‰ç«¯éªŒè¯
            if (newPassword.length < 6) {
                showToast('æ–°å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½', true);
                return;
            }

            if (newPassword !== confirmPassword) {
                showToast('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´', true);
                return;
            }

            if (oldPassword === newPassword) {
                showToast('æ–°å¯†ç ä¸èƒ½ä¸æ—§å¯†ç ç›¸åŒ', true);
                return;
            }

            try {
                const res = await fetch('/api/admin/change-password', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        old_password: oldPassword,
                        new_password: newPassword,
                        confirm_password: confirmPassword
                    })
                });
                const data = await res.json();
                if (data.code === 0) {
                    showToast('å¯†ç ä¿®æ”¹æˆåŠŸï¼Œå³å°†è·³è½¬åˆ°ç™»å½•é¡µé¢');
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('passwordForm').reset();
                    // 2ç§’åè·³è½¬åˆ°ç™»å½•é¡µ
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                } else {
                    showToast(data.message || 'å¯†ç ä¿®æ”¹å¤±è´¥', true);
                }
            } catch (error) {
                showToast('å¯†ç ä¿®æ”¹å¤±è´¥', true);
            }
        }

        // ==================== æ‹–æ‹½æ’åº ====================
        function initDragSort(container, onSortEnd) {
            let draggedItem = null;

            container.querySelectorAll('.list-item').forEach(item => {
                // æ‹–æ‹½å¼€å§‹
                item.addEventListener('dragstart', function(e) {
                    draggedItem = this;
                    this.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', this.innerHTML);
                });

                // æ‹–æ‹½ç»“æŸ
                item.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                    container.querySelectorAll('.list-item').forEach(i => i.classList.remove('drag-over'));
                    draggedItem = null;
                    // è§¦å‘æ’åºä¿å­˜å›è°ƒ
                    if (onSortEnd) onSortEnd();
                });

                // æ‹–æ‹½ç»è¿‡
                item.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    if (this !== draggedItem) {
                        this.classList.add('drag-over');
                    }
                });

                // æ‹–æ‹½ç¦»å¼€
                item.addEventListener('dragleave', function() {
                    this.classList.remove('drag-over');
                });

                // æ”¾ç½®
                item.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');
                    if (this !== draggedItem && draggedItem) {
                        // åˆ¤æ–­æ”¾ç½®ä½ç½®
                        const rect = this.getBoundingClientRect();
                        const midY = rect.top + rect.height / 2;
                        if (e.clientY < midY) {
                            container.insertBefore(draggedItem, this);
                        } else {
                            container.insertBefore(draggedItem, this.nextSibling);
                        }
                    }
                });
            });
        }

        // ä¿å­˜åˆ†ç±»æ’åº
        async function saveCategorySort() {
            const container = document.getElementById('categorySortable');
            if (!container) return;

            const items = container.querySelectorAll('.list-item');
            const sortData = [];
            items.forEach((item, index) => {
                sortData.push({
                    id: parseInt(item.dataset.id),
                    sort_no: index + 1
                });
            });

            try {
                const res = await fetch('/api/admin/categories/sort', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items: sortData })
                });
                const data = await res.json();
                if (data.code === 0) {
                    showToast('æ’åºå·²ä¿å­˜');
                    // æ›´æ–°æœ¬åœ°categoriesæ•°ç»„çš„é¡ºåº
                    const newCategories = [];
                    sortData.forEach(s => {
                        const cat = categories.find(c => c.id === s.id);
                        if (cat) newCategories.push(cat);
                    });
                    categories = newCategories;
                    updateCategorySelect();
                } else {
                    showToast(data.message || 'ä¿å­˜æ’åºå¤±è´¥', true);
                }
            } catch (error) {
                showToast('ä¿å­˜æ’åºå¤±è´¥', true);
            }
        }

        // ä¿å­˜ç«™ç‚¹æ’åº
        async function saveSiteSort(catId) {
            const container = document.getElementById(`siteSortable_${catId}`);
            if (!container) return;

            const items = container.querySelectorAll('.list-item');
            const sortData = [];
            items.forEach((item, index) => {
                sortData.push({
                    id: parseInt(item.dataset.id),
                    sort_no: index + 1
                });
            });

            try {
                const res = await fetch('/api/admin/sites/sort', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items: sortData })
                });
                const data = await res.json();
                if (data.code === 0) {
                    showToast('æ’åºå·²ä¿å­˜');
                } else {
                    showToast(data.message || 'ä¿å­˜æ’åºå¤±è´¥', true);
                }
            } catch (error) {
                showToast('ä¿å­˜æ’åºå¤±è´¥', true);
            }
        }
    </script>
</body>
</html>
