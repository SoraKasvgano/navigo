# 网址导航后台管理系统 - 项目指引

> **重要提示**: 每次对项目进行修改后，AI助手必须同步更新本文档，确保文档与代码保持一致。

---

## 项目概述

这是一个使用 **Go + Gin + SQLite** 开发的导航站点管理系统，提供前台展示页面和后台管理功能。系统通过数据库管理数据，并生成静态 `nav.json` 文件供前端使用。

**技术栈**:
- Go 1.21+
- Gin Web框架
- SQLite (modernc.org/sqlite，纯Go实现)
- 前端: 原生HTML/CSS/JS

---

## 目录结构

```
goversion/
├── main.go              # 程序入口，路由配置
├── config/
│   └── config.go        # 配置管理（环境变量）
├── handlers/            # HTTP处理器（控制器层）
│   ├── auth.go          # 登录/登出认证
│   ├── category.go      # 分类CRUD
│   ├── site.go          # 站点CRUD
│   ├── announcement.go  # 公告CRUD
│   ├── upload.go        # 文件上传/删除
│   ├── nav.go           # 导航数据/页面配置/导入导出
│   └── backup.go        # 完整备份导入导出(zip格式)
├── models/              # 数据模型（数据访问层）
│   ├── user.go          # 用户模型
│   ├── category.go      # 分类模型
│   ├── site.go          # 站点模型
│   ├── announcement.go  # 公告模型
│   └── page_config.go   # 页面配置模型
├── middleware/
│   └── auth.go          # Cookie认证中间件
├── utils/
│   ├── database.go      # 数据库初始化、建表
│   ├── response.go      # 统一响应格式
│   └── navjson.go       # nav.json文件生成
├── templates/           # HTML模板（嵌入到二进制）
│   ├── index.html       # 前台首页
│   ├── admin.html       # 后台管理页
│   └── login.html       # 登录页
├── static/              # 静态资源（嵌入到二进制）
│   ├── style.css        # 样式
│   ├── nav-go.js        # 前端JS
│   └── ...
├── data/                # 运行时数据目录
│   └── admin.db         # SQLite数据库文件
└── uploads/             # 上传文件存储目录
```

---

## 核心文件说明

### 1. main.go (程序入口)
- **职责**: 初始化配置、数据库，配置所有路由
- **关键点**:
  - 使用 `//go:embed` 嵌入 templates 和 static 目录
  - 路由分为公开接口(`/api/*`)和认证接口(`/api/admin/*`)
- **修改场景**: 添加新路由、新Handler

### 2. config/config.go (配置)
- **职责**: 管理所有配置项，支持环境变量覆盖
- **配置项**:
  | 配置 | 环境变量 | 默认值 |
  |------|---------|--------|
  | 端口 | SERVER_PORT | 8080 |
  | 模式 | SERVER_MODE | release |
  | 数据库 | DB_PATH | ./data/admin.db |
  | 上传目录 | UPLOAD_PATH | ./uploads |
  | nav.json路径 | NAV_JSON_PATH | ./static/nav.json |

### 3. handlers/ (控制器层)
| 文件 | 职责 | 主要方法 |
|------|------|---------|
| auth.go | 认证 | Login, Logout, CheckAuth, ChangePassword |
| category.go | 分类管理 | GetAll, Create, Update, Delete, UpdateSort |
| site.go | 站点管理 | GetByCategoryID, Create, Update, Delete, UpdateSort |
| announcement.go | 公告管理 | GetAll, Create, Update, Delete, GetConfig, UpdateConfig |
| upload.go | 文件管理 | UploadFile, DeleteFile, ListFiles |
| nav.go | 导航/配置 | GetNavData, GetPageConfig, ExportData, ImportData |
| backup.go | 完整备份 | ExportBackup, ImportBackup |

### 4. models/ (数据模型)
| 文件 | 数据表 | 关键字段/方法 |
|------|--------|---------|
| user.go | users | id, username, password; UpdatePassword() |
| category.go | categories | id, id_str, classify, icon, sort_no |
| site.go | sites | id, cat_id, name, href, desc, logo, sort_no |
| announcement.go | announcements | id, timestamp, content |
| page_config.go | page_config | title, subtitle, logo, footer_text, icp |

### 5. utils/database.go (数据库)
- **职责**: 初始化数据库连接、创建表结构、初始化默认数据
- **重要**: 修改表结构时需同时修改此文件的 `createTables` 函数

### 6. utils/navjson.go (nav.json生成)
- **职责**: 从数据库读取数据生成静态 nav.json 文件
- **调用时机**: 任何数据变更后（分类/站点/公告/页面配置增删改）
- **线程安全**: 使用 `sync.Mutex` 保护文件写入
- **生成内容**: 包含页面配置、公告配置和所有导航分类数据

---

## nav.json 结构说明

nav.json是前端使用的核心数据文件，由后端自动生成，包含完整的页面配置和导航数据。

### 文件结构
```json
[
  {
    "type": "page_config",
    "title": "网址导航",
    "subtitle": "常用网址一键直达",
    "logo": "/static/logo.png",
    "footer_text": "版权信息",
    "icp": "鲁ICP备xxxxx号"
  },
  {
    "_id": "announcement_config",
    "type": "announcement_config",
    "interval": 5000,
    "announcements": [
      {
        "id": 1,
        "timestamp": "2024-01-01 12:00",
        "content": "公告内容"
      }
    ]
  },
  {
    "_id": "category_id",
    "classify": "分类名称",
    "icon": "ti-folder",
    "sites": [
      {
        "name": "站点名称",
        "href": "https://example.com",
        "desc": "站点描述",
        "logo": "/uploads/logos/example.png"
      }
    ]
  }
]
```

### 数据类型说明
| 类型 | type字段值 | 说明 |
|------|-----------|------|
| 页面配置 | `page_config` | 页面标题、Logo、备案号等全局配置 |
| 公告配置 | `announcement_config` | 公告轮播间隔和公告列表 |
| 导航分类 | 无type字段 | 普通的导航分类和站点数据 |

### 前端处理流程
1. 加载 `nav.json`
2. 提取 `page_config`，更新页面标题、Logo、备案号等
3. 提取 `announcement_config`，初始化公告轮播
4. 渲染剩余的导航分类和站点数据

---

## API路由表

### 公开接口
| 方法 | 路径 | 功能 |
|------|------|------|
| GET | / | 前台首页 |
| GET | /admin | 后台管理页 |
| GET | /login | 登录页 |
| GET | /nav.json | 静态导航数据 |
| POST | /api/login | 登录 |
| GET | /api/check-auth | 检查登录状态 |
| GET | /api/nav | 获取导航数据(API) |

### 认证接口 (/api/admin/*)
| 方法 | 路径 | 功能 |
|------|------|------|
| POST | /logout | 登出 |
| PUT | /change-password | 修改密码 |
| GET/POST/PUT/DELETE | /categories | 分类CRUD |
| PUT | /categories/sort | 分类排序 |
| GET/POST/PUT/DELETE | /sites | 站点CRUD |
| PUT | /sites/sort | 站点排序 |
| GET/POST/PUT/DELETE | /announcements | 公告CRUD |
| GET/PUT | /announcement-config | 公告配置 |
| GET/PUT | /page-config | 页面配置 |
| POST/DELETE/GET | /upload, /files | 文件管理 |
| GET/POST | /export, /import | 数据导入导出(JSON) |
| GET/POST | /backup/export, /backup/import | 完整备份(zip格式) |

---

## 数据库表结构

```sql
-- 用户表
users (id, username, password, created_at, updated_at)

-- 分类表
categories (id, id_str, classify, icon, sort_no)

-- 站点表 (外键关联categories)
sites (id, cat_id, name, href, description, logo, sort_no)

-- 公告表
announcements (id, timestamp, content)

-- 公告配置表 (单行)
announcement_config (id=1, interval)

-- 页面配置表 (单行)
page_config (id=1, title, subtitle, logo, footer_text, icp)
```

---

## 常见修改场景

### 场景1: 添加新的API接口
1. 在 `handlers/` 下对应文件添加方法
2. 在 `main.go` 中注册路由
3. **更新本文档的API路由表**

### 场景2: 修改数据模型/表结构
1. 修改 `models/` 下对应文件的结构体
2. 修改 `utils/database.go` 中的建表SQL
3. 修改相关 handler 和 navjson.go
4. **更新本文档的数据库表结构**

### 场景3: 修改前端页面
1. 修改 `templates/` 下对应HTML文件
2. 修改 `static/` 下对应CSS/JS文件
3. 重新编译程序（因为使用embed嵌入）

### 场景4: 添加新的配置项
1. 在 `config/config.go` 添加配置结构和初始化
2. 在使用处引用 `config.AppConfig.XXX`
3. **更新本文档的配置项表格**

### 场景5: 修改nav.json输出格式
1. 修改 `utils/navjson.go` 中的结构体和生成逻辑
2. 同步修改前端 `static/nav-go.js` 的解析逻辑
3. **更新本文档的nav.json结构说明**

### 场景6: 更新页面配置（标题/Logo/备案号等）
1. 用户通过管理后台"页面配置"修改
2. 后端自动调用 `utils.GenerateNavJSON()` 更新nav.json
3. 前端加载nav.json时自动应用新配置
4. **无需手动修改代码，通过数据库管理**

---

## 前端功能说明

### 样式配色方案
前端左侧导航栏使用中灰色配色方案，与万年历区域协调搭配：

**关键CSS变量** (在 `static/style.css` 中):
```css
:root {
  --apple-blue: #007AFF;           /* 主色调（蓝色） */
  --apple-secondary-bg: #4a4e5a;   /* 左侧导航栏背景色（中灰色） */
}
```

**配色理念**:
- 左侧导航栏: `#4a4e5a` (中灰色，稍深)
- 万年历背景: `rgba(255, 255, 255, 0.1)` (白色半透明)
- 颜色搭配协调，避免过于暗沉或对比过大

### 页面配置动态加载
前端通过nav.json加载所有页面配置，实现零硬编码：

**加载的配置项**:
| 配置项 | 对应字段 | 应用位置 |
|-------|---------|---------|
| 页面标题 | `title` | 浏览器标题栏、左侧导航标题 |
| 副标题 | `subtitle` | 左侧导航副标题区域 |
| Logo | `logo` | 左侧导航顶部Logo |
| 页脚文字 | `footer_text` | 底部版权信息 |
| 备案号 | `icp` | 万年历下方备案链接 |

**实现位置**: `static/nav-go.js` 中的nav.json加载逻辑

### 拖拽排序功能
后台管理页面 (`templates/admin.html`) 支持通过拖拽调整分类和站点的排序：

**实现方式**:
- 使用原生 HTML5 Drag and Drop API
- 每个列表项左侧显示拖拽图标 (☰)
- 拖拽完成后自动调用后端API保存排序

**相关函数** (在 `admin.html` 中):
| 函数 | 功能 |
|------|------|
| `initDragSort(container, onSortEnd)` | 初始化拖拽排序，绑定事件监听器 |
| `saveCategorySort()` | 保存分类排序到后端 (PUT /api/admin/categories/sort) |
| `saveSiteSort(catId)` | 保存站点排序到后端 (PUT /api/admin/sites/sort) |

**CSS类**:
- `.sortable-list`: 可排序容器
- `.drag-handle`: 拖拽手柄样式
- `.dragging`: 拖拽中的元素
- `.drag-over`: 放置目标元素
- `.sort-hint`: 排序提示文字

---

## 构建与运行

### 方式一：Docker部署（生产环境推荐）

#### 使用快速部署脚本

**Linux/Mac:**
```bash
cd goversion
chmod +x deploy.sh
sudo ./deploy.sh
```

**Windows:**
```bash
cd goversion
deploy.bat
```

#### 手动部署

```bash
# 创建数据目录
sudo mkdir -p /home/docker/navigo/{data,uploads,static}
sudo chown -R 1000:1000 /home/docker/navigo

# 构建并启动
cd goversion
docker-compose up -d --build

# 查看日志
docker-compose logs -f navigo

# 查看状态
docker-compose ps
```

**Docker配置**:
- 容器名称: navigo
- 端口映射: 8787:8080
- 重启策略: unless-stopped
- 网络模式: bridge
- 数据目录: /home/docker/navigo

**详细Docker部署文档**: 查看 [DOCKER.md](DOCKER.md)

### 方式二：直接运行（开发环境）

```bash
# 开发运行
cd goversion
go run .

# 编译
go build -o nav-admin.exe .

# 运行
./nav-admin.exe
```

**默认账号**: admin / admin

**访问地址**:
- Docker部署: http://localhost:8787/ (前台), http://localhost:8787/admin (后台)
- 直接运行: http://localhost:8080/ (前台), http://localhost:8080/admin (后台)

---

## 关键依赖

```
github.com/gin-gonic/gin      # Web框架
modernc.org/sqlite            # 纯Go SQLite驱动
golang.org/x/crypto/bcrypt    # 密码加密
```

---

## AI修改须知

1. **每次修改代码后，必须同步更新本文档**
2. 修改 handlers 时，检查是否需要调用 `utils.GenerateNavJSON()` 更新nav.json
3. 所有数据修改操作应使用事务 (`tx`)
4. 新增API需要在 `main.go` 注册路由并更新本文档
5. 修改表结构需要同时修改 `models/` 和 `utils/database.go`
6. 前端模板修改后需要重新编译（使用了embed）

---

## 安全开发规范

### 前端不可信原则
后端必须对所有前端传入的数据进行严格验证，不能假设前端数据是合法的。

### 排序API安全验证清单
`handlers/category.go` 和 `handlers/site.go` 的 `UpdateSort` 方法已实现以下验证：

| 验证项 | 说明 |
|--------|------|
| 数组长度限制 | 分类最多100项，站点最多500项，防止DoS |
| ID有效性 | ID必须大于0 |
| ID存在性 | 数据库验证ID确实存在 |
| ID唯一性 | 检查列表中是否有重复ID |
| sort_no范围 | 限制在0-10000之间 |
| 站点归属验证 | 站点排序时验证所有站点属于同一分类 |
| 影响行数验证 | 确保UPDATE确实修改了1行 |

### 新增API安全要求
添加新的API时，必须遵循以下原则：

1. **输入验证**: 所有输入参数必须验证类型、范围、长度
2. **存在性检查**: 涉及ID的操作必须先验证记录存在
3. **权限验证**: 验证操作的资源是否属于当前用户/会话
4. **数量限制**: 批量操作必须限制单次处理数量
5. **事务使用**: 多步骤操作使用事务保证原子性
6. **错误处理**: 不要向前端暴露内部错误详情

---

## 完整备份功能

### 功能说明
`handlers/backup.go` 提供完整的数据备份和恢复功能，将nav.json数据和上传的文件（站点logo等）打包为zip文件。

### API接口
| 方法 | 路径 | 功能 |
|------|------|------|
| GET | /api/admin/backup/export | 导出完整备份(zip) |
| POST | /api/admin/backup/import | 导入zip备份文件 |

### Zip文件结构
```
nav_backup_20260101_120000.zip
├── nav.json                    # 导航数据（分类、站点、公告）
└── uploads/
    ├── logos/                  # 站点logo图片
    │   └── *.png, *.jpg, ...
    └── files/                  # 其他上传文件
        └── *.pdf, *.doc, ...
```

### 安全验证措施
导入时执行严格的安全检查：

| 检查项 | 说明 |
|--------|------|
| 文件格式验证 | 只接受.zip格式 |
| 文件大小限制 | 总文件50MB，单文件10MB |
| 路径穿越防护 | 检测`..`等非法路径，防止目录穿越攻击 |
| 白名单文件类型 | 只允许图片(.png/.jpg/.jpeg/.gif/.webp/.ico/.svg)和文档(.txt/.pdf/.ppt/.doc/.xls等) |
| 文件名格式检查 | 只允许字母、数字、下划线、横线、点 |
| nav.json结构验证 | 检查必要字段(_id, classify, name, href等) |
| logo/href路径验证 | 防止路径注入 |

### 与JSON导入导出的区别
| 功能 | JSON导入导出 | 完整备份(zip) |
|------|-------------|---------------|
| 数据内容 | 仅nav.json | nav.json + 上传文件 |
| 文件格式 | JSON | ZIP |
| 站点logo | 仅保存URL路径 | 包含实际文件 |
| 适用场景 | 快速导出数据 | 完整迁移/备份 |

---

*文档最后更新: 2026-01-03*

**本次更新内容**:
1. 添加 nav.json 结构说明章节
2. 页面配置（标题/Logo/备案号等）现在通过 nav.json 统一管理
3. 添加前端样式配色方案说明
4. 更新页面配置修改场景说明
5. 左侧导航栏配色优化（`#2c2c2e` → `#4a4e5a`）
6. **新增 Docker 部署支持**
   - 添加 Dockerfile（多阶段构建，Alpine Linux基础镜像）
   - 添加 docker-compose.yml（bridge网络，unless-stopped重启策略）
   - 添加 .dockerignore（优化构建速度）
   - 创建 DOCKER.md 详细部署文档
   - 提供快速部署脚本（deploy.sh 和 deploy.bat）
   - 容器配置：name=navigo, port=8787:8080, data=/home/docker/navigo
